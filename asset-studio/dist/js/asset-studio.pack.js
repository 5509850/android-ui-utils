/*
Copyright 2010 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
var Base=function(){};Base.extend=function(b,e){var f=Base.prototype.extend;Base._prototyping=true;var d=new this;f.call(d,b);delete Base._prototyping;var c=d.constructor;var a=d.constructor=function(){if(!Base._prototyping){if(this._constructing||this.constructor==a){this._constructing=true;c.apply(this,arguments);delete this._constructing}else{if(arguments[0]!=null){return(arguments[0].extend||f).call(arguments[0],d)}}}};a.ancestor=this;a.extend=this.extend;a.forEach=this.forEach;a.implement=this.implement;a.prototype=d;a.toString=this.toString;a.valueOf=function(g){return(g=="object")?a:c.valueOf()};f.call(a,e);if(typeof a.init=="function"){a.init()}return a};Base.prototype={extend:function(b,h){if(arguments.length>1){var e=this[b];if(e&&(typeof h=="function")&&(!e.valueOf||e.valueOf()!=h.valueOf())&&/\bbase\b/.test(h)){var a=h.valueOf();h=function(){var k=this.base||Base.prototype.base;this.base=e;var i=a.apply(this,arguments);this.base=k;return i};h.valueOf=function(i){return(i=="object")?h:a};h.toString=Base.toString}this[b]=h}else{if(b){var g=Base.prototype.extend;if(!Base._prototyping&&typeof this!="function"){g=this.extend||g}var d={toSource:null};var f=["constructor","toString","valueOf"];var c=Base._prototyping?0:1;while(j=f[c++]){if(b[j]!=d[j]){g.call(this,j,b[j])}}for(var j in b){if(!d[j]){g.call(this,j,b[j])}}}}return this},base:function(){}};Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(a,d,c){for(var b in a){if(this.prototype[b]===undefined){d.call(c,a[b],b,a)}}},implement:function(){for(var a=0;a<arguments.length;a++){if(typeof arguments[a]=="function"){arguments[a](this.prototype)}else{this.prototype.extend(arguments[a])}}return this},toString:function(){return String(this.valueOf())}});(function(){var c={};var b={create:function(){var f=arguments[0];function d(){this.initialize.apply(this,arguments)}for(var e in f){d.prototype[e]=f[e]}if(!d.prototype.initialize){d.prototype.initialize=function(){}}return d}};var a=b.create({initialize:function(e,g,d,f){this.r=(Math.sqrt(e.length)-1)/2;this.matrix=e;this.divisor=g;this.bias=d;this.separable=f},apply:function(e,p){var v=e.width,j=e.height;var n=e.data;var f=p.data;var o,i,u;var d,l,s;for(var q=0;q<j;++q){for(var t=0;t<v;++t){u=d=l=s=0;o=(q*v+t)<<2;for(var k=-this.r;k<=this.r;++k){for(var m=-this.r;m<=this.r;++m){i=(Math.max(0,Math.min(j-1,q+k))*v+Math.max(0,Math.min(v-1,t+m)))<<2;d+=n[i]*this.matrix[u];l+=n[i+1]*this.matrix[u];s+=n[i+2]*this.matrix[u];u++}}f[o]=d/this.divisor+this.bias;f[o+1]=l/this.divisor+this.bias;f[o+2]=s/this.divisor+this.bias;f[o+3]=255}}}});c.drawing={};c.drawing.context=function(e){var d=document.createElement("canvas");d.width=e.w;d.height=e.h;return d.getContext("2d")};c.drawing.copy=function(f,e,d){f.drawImage(e.canvas||e,0,0,d.w,d.h)};c.drawing.clear=function(d,e){d.clearRect(0,0,e.w,e.h)};c.drawing.drawCenterInside=function(j,g,i,f){if(f.w/f.h>i.w/i.h){var e=f.h*i.w/f.w;j.drawImage(g.canvas||g,f.x,f.y,f.w,f.h,i.x,i.y+(i.h-e)/2,i.w,e)}else{var d=f.w*i.h/f.h;j.drawImage(g.canvas||g,f.x,f.y,f.w,f.h,i.x+(i.w-d)/2,i.y,d,i.h)}};c.drawing.drawCenterCrop=function(j,g,i,f){if(f.w/f.h>i.w/i.h){var d=f.h*i.w/i.h;j.drawImage(g.canvas||g,f.x+(f.w-d)/2,f.y,d,f.h,i.x,i.y,i.w,i.h)}else{var e=f.w*i.h/i.w;j.drawImage(g.canvas||g,f.x,f.y+(f.h-e)/2,f.w,e,i.x,i.y,i.w,i.h)}};c.drawing.getTrimRect=function(o,p,f){if(!o.canvas){var d=o;o=c.drawing.context(p);c.drawing.copy(o,d,p)}if(f==0){return{x:0,y:0,w:p.w,h:p.h}}f=f||1;var g=p.w,n=p.h,e=0,k=0;var i=o.getImageData(0,0,p.w,p.h).data;var h;for(var j=0;j<p.h;j++){for(var m=0;m<p.w;m++){h=i[((j*p.w+m)<<2)+3];if(h>f){g=Math.min(m,g);n=Math.min(j,n);e=Math.max(m,e);k=Math.max(j,k)}}}if(g>e){return{x:0,y:0,w:p.w,h:p.h}}return{x:g,y:n,w:e-g+1,h:k-n+1}};c.drawing.copyAsAlpha=function(h,g,e,f,d){f=f||"#fff";d=d||"#000";h.save();h.clearRect(0,0,e.w,e.h);h.globalCompositeOperation="source-over";c.drawing.copy(h,g,e);h.globalCompositeOperation="source-atop";h.fillStyle=f;h.fillRect(0,0,e.w,e.h);h.globalCompositeOperation="destination-atop";h.fillStyle=d;h.fillRect(0,0,e.w,e.h);h.restore()};c.drawing.makeAlphaMask=function(o,p,e){var d=o.getImageData(0,0,p.w,p.h);var l=o.createImageData(p.w,p.h);var k=d.data;var f=l.data;var h,j;for(var m=0;m<p.h;m++){for(var n=0;n<p.w;n++){h=(m*p.w+n)<<2;j=0.3*k[h]+0.59*k[h+1]+0.11*k[h+2];f[h]=f[h+1]=f[h+2]=255;f[h+3]=j}}o.putImageData(l,0,0);if(e){o.save();o.globalCompositeOperation="source-atop";o.fillStyle=e;o.fillRect(0,0,p.w,p.h);o.restore()}};c.drawing.applyFilter=function(f,d,e){var g=d.getImageData(0,0,e.w,e.h);var h=d.createImageData(e.w,e.h);f.apply(g,h);d.putImageData(h,0,0)};c.drawing.blur=function(g,p,s){var q=Math.ceil(g);var d=q*2+1;var m=new Array(d*d);var o=g/3;var h=2*o*o;var n=Math.sqrt(Math.PI*h);var l=g*g;var j=0;var f=0;var e;for(var i=-q;i<=q;i++){for(var k=-q;k<=q;k++){e=1*k*k+1*i*i;if(e>l){m[f]=0}else{m[f]=Math.exp(-e/h)/n}j+=m[f];f++}}c.drawing.applyFilter(new a(m,j,0,true),p,s)};c.drawing.fx=function(e,j,d,p){e=e||[];var f=[];var g=[];var h=[];for(var k=0;k<e.length;k++){if(/^outer/.test(e[k].effect)){f.push(e[k])}else{if(/^inner/.test(e[k].effect)){g.push(e[k])}else{if(/^fill/.test(e[k].effect)){h.push(e[k])}}}}var n=c.drawing.context(p);var l=c.drawing.context(p);for(var k=0;k<f.length;k++){var o=f[k];j.save();switch(o.effect){case"outer-shadow":c.drawing.clear(n,p);c.drawing.copyAsAlpha(n,d.canvas||d,p);if(o.blur){c.drawing.blur(o.blur,n,p)}c.drawing.makeAlphaMask(n,p,o.color||"#000");if(o.translate){j.translate(o.translate.x||0,o.translate.y||0)}j.globalAlpha=Math.max(0,Math.min(1,o.opacity||1));c.drawing.copy(j,n,p);break}j.restore()}j.save();c.drawing.clear(n,p);c.drawing.copy(n,d.canvas||d,p);if(h.length){var o=h[0];n.save();n.globalCompositeOperation="source-atop";switch(o.effect){case"fill-color":n.fillStyle=o.color;break;case"fill-lineargradient":var m=n.createLinearGradient(o.from.x,o.from.y,o.to.x,o.to.y);for(var k=0;k<o.colors.length;k++){m.addColorStop(o.colors[k].offset,o.colors[k].color)}n.fillStyle=m;break}n.fillRect(0,0,p.w,p.h);n.restore()}j.globalAlpha=1;c.drawing.copy(j,n,p);for(var k=0;k<g.length;k++){var o=g[k];n.save();switch(o.effect){case"inner-shadow":c.drawing.clear(n,p);c.drawing.copyAsAlpha(n,d.canvas||d,p,"#fff","#000");c.drawing.copyAsAlpha(l,d.canvas||d,p);if(o.blur){c.drawing.blur(o.blur,l,p)}c.drawing.makeAlphaMask(l,p,"#000");if(o.translate){n.translate(o.translate.x||0,o.translate.y||0)}n.globalCompositeOperation="source-over";c.drawing.copy(n,l,p);c.drawing.makeAlphaMask(n,p,o.color);j.globalAlpha=Math.max(0,Math.min(1,o.opacity||1));c.drawing.copy(j,n,p);break}n.restore()}j.restore()};c.loadImageResources=function(d,i){var g={};var f=function(){for(var j in d){if(!(j in g)){return}}(i||function(){})(g);i=null};for(var h in d){var e=document.createElement("img");e.src=d[h];(function(j,k){j.onload=function(){g[k]=j;f()};j.onerror=function(){g[k]=null;f()}})(e,h)}};c.loadFromUri=function(e,f){f=f||function(){};var d=document.createElement("img");d.src=e;d.onload=function(){f(d)};d.onerror=function(){f(null)}};c.toDataUri=function(e){var f=document.createElement("canvas");f.width=e.naturalWidth;f.height=e.naturalHeight;var d=f.getContext("2d");d.drawImage(e,0,0);return f.toDataURL()};window.imagelib=c})();(function(){var b={};b.checkBrowser=function(){var c=navigator.userAgent.match(/Chrome\/(\d+)/);var e=false;if(c){var d=parseInt(c[1],10);if(d>=6){e=true}}if(!e){$("<div>").addClass("browser-unsupported-note ui-state-highlight").attr("title","Your browser is not supported.").append($('<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;">')).append($("<p>").html('Currently only <a href="http://www.google.com/chrome">Chrome 6+</a> is recommended and supported. Your mileage may vary with other browsers.')).prependTo("body")}};(function(c){c.widget("ui.combobox",{_create:function(){var f=this,d=this.element.hide(),g=d.children(":selected"),h=g.val()?g.text():"";var e=c("<input>").insertAfter(d).val(h).autocomplete({delay:0,minLength:0,source:function(j,i){var k=new RegExp(c.ui.autocomplete.escapeRegex(j.term),"i");i(d.children("option").map(function(){var l=c(this).text();if(this.value&&(!j.term||k.test(l))){return{label:l.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.ui.autocomplete.escapeRegex(j.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"),value:l,option:this}}}))},select:function(i,j){j.item.option.selected=true;window.foo=f;f._trigger("selected",i,{item:j.item.option})},change:function(j,k){if(!k.item){var l=new RegExp("^"+c.ui.autocomplete.escapeRegex(c(this).val())+"$","i"),i=false;d.children("option").each(function(){if(this.value.match(l)){this.selected=i=true;return false}});if(!i){c(this).val("");d.val("");return false}}}}).addClass("ui-widget ui-widget-content ui-corner-left");e.data("autocomplete")._renderItem=function(i,j){return c("<li></li>").data("item.autocomplete",j).append("<a>"+j.label+"</a>").appendTo(i)};c("<button>&nbsp;</button>").attr("tabIndex",-1).attr("title","Show All Items").insertAfter(e).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("ui-corner-right ui-button-icon").click(function(){if(e.autocomplete("widget").is(":visible")){e.autocomplete("close");return}e.autocomplete("search","");e.focus()})}})})(jQuery);b.forms={};b.forms.Form=Base.extend({constructor:function(e,d){this.id_=e;this.params_=d;this.fields_=d.fields;for(var c=0;c<this.fields_.length;c++){this.fields_[c].setForm_(this)}this.onChange=this.params_.onChange||function(){}},createUI:function(c){for(var d=0;d<this.fields_.length;d++){var e=this.fields_[d];e.createUI(c)}},notifyChanged_:function(){this.onChange()},getValues:function(){var c={};for(var d=0;d<this.fields_.length;d++){var e=this.fields_[d];c[e.id_]=e.getValue()}return c}});b.forms.Field=Base.extend({constructor:function(d,c){this.id_=d;this.params_=c},setForm_:function(c){this.form_=c},getHtmlId:function(){return"_frm-"+this.form_.id_+"-"+this.id_},createUI:function(c){c=$(c);return $("<div>").addClass("form-field-outer").append($("<label>").attr("for",this.getHtmlId()).text(this.params_.title).append($("<div>").addClass("form-field-help-text").css("display",this.params_.helpText?"":"none").html(this.params_.helpText))).append($("<div>").addClass("form-field-container")).appendTo(c)}});b.forms.TextField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<input>").addClass("form-text ui-widget ui-widget-content ui-autocomplete-input ui-corner-all").attr("type","text").val(this.getValue()).bind("keydown change",function(){var f=this;window.setTimeout(function(){d.setValue($(f).val());d.form_.notifyChanged_()},0)}).appendTo(e)},getValue:function(){var c=this.value_;if(typeof c!="string"){c=this.params_.defaultValue||""}return c},setValue:function(c){this.value_=c}});b.forms.ColorField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<div>").addClass("form-color").attr("id",this.getHtmlId()).append($("<div>").addClass("form-color-preview").css("background-color",this.getValue().color)).button({label:null,icons:{secondary:"ui-icon-carat-1-s"}}).appendTo(e);this.el_.ColorPicker({color:this.getValue().color,onChange:function(f,h,g){d.setValue("#"+h);$(".form-color-preview",d.el_).css("background-color",d.getValue().color);d.form_.notifyChanged_()}});if(this.params_.alpha){this.alphaEl_=$("<div>").addClass("form-color-alpha").slider({min:0,max:100,range:"min",value:this.getValue().alpha,slide:function(f,g){d.setAlpha(g.value);d.form_.notifyChanged_()}}).appendTo(e)}},getValue:function(){var c=this.value_||this.params_.defaultValue||"#000000";if(/^([0-9a-f]{6}|[0-9a-f]{3})$/i.test(c)){c="#"+c}var d=this.alpha_;if(typeof d!="number"){d=this.params_.defaultAlpha;if(typeof d!="number"){d=100}}return{color:c,alpha:d}},setValue:function(c){this.value_=c},setAlpha:function(c){this.alpha_=c}});b.forms.EnumField=b.forms.Field.extend({createUI:function(c){var g=$(".form-field-container",this.base(c));var f=this;if(this.params_.buttons){this.el_=$("<div>").attr("id",this.getHtmlId()).addClass(".form-field-buttonset").appendTo(g);for(var d=0;d<this.params_.options.length;d++){var e=this.params_.options[d];$("<input>").attr({type:"radio",name:this.getHtmlId(),id:this.getHtmlId()+"-"+e.id,value:e.id}).change(function(){f.form_.notifyChanged_()}).appendTo(this.el_);$("<label>").attr("for",this.getHtmlId()+"-"+e.id).text(e.title).appendTo(this.el_)}this.findAndSetValue(this.params_.defaultValue||this.params_.options[0].id);this.el_.buttonset()}else{this.el_=$("<select>").attr("id",this.getHtmlId()).change(function(){f.form_.notifyChanged_()}).appendTo(g);for(var d=0;d<this.params_.options.length;d++){var e=this.params_.options[d];$("<option>").attr("value",e.id).text(e.title).appendTo(this.el_)}this.el_.combobox({selected:function(h,i){f.form_.notifyChanged_()}})}},getValue:function(){return this.params_.buttons?$("input:checked",this.el_).val():this.el_.val()},setValue:function(c){this.findAndSetValue(c)},findAndSetValue:function(c){if(this.params_.buttons){$("input",this.el_).each(function(d,e){$(e).attr("checked",$(e).val()==c)})}else{this.el_.val(c)}}});b.forms.BooleanField=b.forms.EnumField.extend({constructor:function(d,c){c.options=[{id:"1",title:c.onText||"Yes"},{id:"0",title:c.offText||"No"}];c.defaultValue=c.defaultValue?"1":"0";c.buttons=true;this.base(d,c)},getValue:function(){return this.base()=="1"},setValue:function(c){this.base(c?"1":"0")}});b.forms.RangeField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<div>").addClass("form-range").slider({min:this.params_.min||0,max:this.params_.max||100,step:this.params_.step||1,range:"min",value:this.getValue(),slide:function(f,g){d.setValue(g.value);d.form_.notifyChanged_()}}).appendTo(e)},getValue:function(){var c=this.value_;if(typeof c!="number"){c=this.params_.defaultValue;if(typeof c!="number"){c=0}}return c},setValue:function(c){this.value_=c}});var a=window.canvg&&true;b.forms.ImageField=b.forms.Field.extend({constructor:function(d,c){this.valueType_=null;this.textParams_={};this.imageParams_={};this.trimFormValues_={};this.base(d,c)},createUI:function(d){var k=this.base(d);var j=$(".form-field-container",k);var m=this;k.addClass("form-field-drop-target");k.get(0).ondragenter=b.forms.ImageField.makeDragenterHandler_(k);k.get(0).ondragleave=b.forms.ImageField.makeDragleaveHandler_(k);k.get(0).ondragover=b.forms.ImageField.makeDragoverHandler_(k);k.get(0).ondrop=b.forms.ImageField.makeDropHandler_(k,function(i){m.loadFromFileList_(i.dataTransfer.files,function(p){if(!p){return}m.setValueType_("image");m.imageParams_=p;m.valueFilename_=p.name;m.renderValueAndNotifyChanged_()})});this.el_=$("<div>").attr("id",this.getHtmlId()).addClass(".form-field-buttonset").appendTo(j);var l=["image","Image","clipart","Clipart","text","Text"];var f={};for(var h=0;h<l.length/2;h++){$("<input>").attr({type:"radio",name:this.getHtmlId(),id:this.getHtmlId()+"-"+l[h*2],value:l[h*2]}).appendTo(this.el_);f[l[h*2]]=$("<label>").attr("for",this.getHtmlId()+"-"+l[h*2]).text(l[h*2+1]).appendTo(this.el_)}this.el_.buttonset();this.fileEl_=$("<input>").addClass("form-image-hidden-file-field").attr({id:this.getHtmlId(),type:"file",accept:"image/*"}).change(function(){m.loadFromFileList_(m.fileEl_.get(0).files,function(i){if(!i){return}m.setValueType_("image");m.imageParams_=i;m.valueFilename_=i.name;m.renderValueAndNotifyChanged_()})}).appendTo(this.el_);f.image.click(function(i){m.fileEl_.trigger("click");m.setValueType_(null);m.renderValueAndNotifyChanged_();i.preventDefault();return false});var c=$("<div>").addClass("form-image-type-params form-image-type-params-clipart").hide().appendTo(this.el_);var o=$("<div>").addClass("form-image-clipart-list").appendTo(c);for(var h=0;h<b.forms.ImageField.clipartList_.length;h++){var n="res/clipart/"+b.forms.ImageField.clipartList_[h];$("<img>").addClass("form-image-clipart-item").attr("src",n).click(function(i){return function(){var p=a&&i.match(/\.svg$/);$("img",c).removeClass("selected");$(this).addClass("selected");m.imageParams_={canvgSvgUri:p?i:null,uri:p?null:i};m.valueFilename_=i.match(/[^/]+$/)[0];m.renderValueAndNotifyChanged_()}}(n)).appendTo(o)}f.clipart.click(function(i){m.setValueType_("clipart");m.renderValueAndNotifyChanged_()});var g=$("<div>").addClass("form-subform form-image-type-params form-image-type-params-text").hide().appendTo(this.el_);var e=[];for(var h=0;h<b.forms.ImageField.fontList_.length;h++){e.push({id:h+1,title:b.forms.ImageField.fontList_[h].title})}this.textForm_=new b.forms.Form(this.form_.id_+"-"+this.id_+"-textform",{onChange:function(){var i=m.textForm_.getValues();m.textParams_.text=i.text;m.textParams_.fontStack=i.font?b.forms.ImageField.fontList_[i.font-1].stack:"sans-serif";m.valueFilename_=i.text;m.renderValueAndNotifyChanged_()},fields:[new b.forms.TextField("text",{title:"Text",}),new b.forms.EnumField("font",{title:"Font",options:e}),]});this.textForm_.createUI(g);f.text.click(function(i){m.setValueType_("text");m.renderValueAndNotifyChanged_()});this.trimFormValues_={};this.trimForm_=new b.forms.Form(this.form_.id_+"-"+this.id_+"-trimform",{onChange:function(){m.trimFormValues_=m.trimForm_.getValues();m.renderValueAndNotifyChanged_()},fields:[new b.forms.BooleanField("trim",{title:"Trim",defaultValue:this.params_.defaultValueTrim||false,offText:"Don't Trim",onText:"Trim"}),new b.forms.RangeField("pad",{title:"Padding",defaultValue:0,min:0,max:0.5,step:0.05}),]});this.trimForm_.createUI($("<div>").addClass("form-subform").appendTo(j));this.trimFormValues_=this.trimForm_.getValues();this.imagePreview_=$("<img>").addClass("form-image-preview").hide().appendTo(j.parent())},setValueType_:function(c){this.valueType_=c;$("label",this.el_).removeClass("ui-state-active");$(".form-image-type-params",this.el_).hide();if(c){$("label[for="+this.getHtmlId()+"-"+c+"]").addClass("ui-state-active");$(".form-image-type-params-"+c,this.el_).show()}},loadFromFileList_:function(d,j){d=d||[];var h=this;var f=null;for(var e=0;e<d.length;e++){if(b.forms.ImageField.isValidFile_(d[e])){f=d[e];break}}if(!f){alert("Please choose a valid image file (PNG, JPG, GIF, SVG, etc.)");j(null);return}var g=a&&f.type=="image/svg+xml";var c=new FileReader();c.onload=function(i){j({uri:g?null:i.target.result,canvgSvgText:g?i.target.result:null,name:f.name})};c.onerror=function(i){switch(i.target.error.code){case i.target.error.NOT_FOUND_ERR:alert("File not found!");break;case i.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case i.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}j(null)};c.onabort=function(i){alert("File read cancelled");j(null)};if(g){c.readAsText(f)}else{c.readAsDataURL(f)}},clearValue:function(){this.valueType_=null;this.valueFilename_=null;this.valueUri_=null;this.fileEl_.val("");this.imagePreview_.hide()},getValue:function(){return{uri:this.valueUri_,name:this.valueFilename_}},renderValueAndNotifyChanged_:function(){if(!this.valueType_){this.valueUri_=null}var g=this;switch(this.valueType_){case"image":case"clipart":if(this.imageParams_.canvgSvgText||this.imageParams_.canvgSvgUri){var e=document.createElement("canvas");var f={w:800,h:800};e.className="offscreen";e.width=f.w;e.height=f.h;document.body.appendChild(e);canvg(e,this.imageParams_.canvgSvgText||this.imageParams_.canvgSvgUri,{scaleWidth:f.w,scaleHeight:f.h,ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true});d(e.getContext("2d"),f);document.body.removeChild(e)}else{if(this.imageParams_.uri){imagelib.loadFromUri(this.imageParams_.uri,function(j){var k={w:j.naturalWidth,h:j.naturalHeight};var i=imagelib.drawing.context(k);imagelib.drawing.copy(i,j,k);d(i,k)})}}break;case"text":var f={w:4000,h:800};var c=imagelib.drawing.context(f);var h=this.textParams_.text||"";c.fillStyle="#000";c.font="bold "+f.h+"px/"+f.h+"px "+(this.textParams_.fontStack||"sans-serif");c.textBaseline="bottom";c.fillText(h,0,f.h);f.w=c.measureText(h).width||f.w;d(c,f);break}function d(l,j){var k={x:0,y:0,w:j.w,h:j.h};if(g.trimFormValues_.trim){k=imagelib.drawing.getTrimRect(l,j)}var n=(g.trimFormValues_.pad||0)*Math.min(k.w,k.h);var m={x:n,y:n,w:k.w,h:k.h};var i=imagelib.drawing.context({w:k.w+n*2,h:k.h+n*2});imagelib.drawing.drawCenterInside(i,l,m,k);g.valueUri_=i.canvas.toDataURL();if(g.imagePreview_){g.imagePreview_.attr("src",g.valueUri_);g.imagePreview_.show()}g.form_.notifyChanged_()}}});b.forms.ImageField.clipartList_=["icons/add.svg","icons/back.svg","icons/block.svg","icons/camera.svg","icons/edit.svg","icons/export.svg","icons/home.svg","icons/map_pin.svg","icons/mylocation.svg","icons/play_clip.svg","icons/refresh.svg","icons/search.svg","icons/share.svg","icons/sort_by_size.svg","icons/star.svg","icons/stop.svg"];b.forms.ImageField.fontList_=[{title:"Helvetica / Arial",stack:"helvetica, arial, sans-serif"},{title:"Georgia",stack:"georgia, serif"},{title:"Book Antiqua / Palatino",stack:'"Book Antiqua", palatino, "Palatino Linotype", serif'},{title:"Courier",stack:"courier, monospace"},{title:"Courier New",stack:'"Courier New", monospace'},{title:"Webdings",stack:'"Webdings"'},{title:"Wingdings",stack:'"Wingdings"'},];b.forms.ImageField.isValidFile_=function(c){return !!c.type.toLowerCase().match(/^image\//)};b.forms.ImageField.makeDropHandler_=function(d,c){return function(e){$(d).removeClass("drag-hover");c(e)}};b.forms.ImageField.makeDragoverHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_);c._studio_frm_dragtimeout_=null}d.dataTransfer.dropEffect="link";d.preventDefault()}};b.forms.ImageField.makeDragenterHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_);c._studio_frm_dragtimeout_=null}$(c).addClass("drag-hover");d.preventDefault()}};b.forms.ImageField.makeDragleaveHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_)}c._studio_frm_dragtimeout_=window.setTimeout(function(){$(c).removeClass("drag-hover")},100)}};b.ui={};b.ui.createImageOutputSlot=function(c){$("<div>").addClass("out-image-block").append($("<div>").text(c.label)).append($("<img>").addClass("out-image").attr("id",c.id)).appendTo(c.container)};b.ui.drawImageGuideRects=function(c,e,f){f=f||[];c.save();c.globalAlpha=0.5;c.fillStyle="#fff";c.fillRect(0,0,e.w,e.h);c.globalAlpha=1;var g=b.ui.drawImageGuideRects.guideColors_;for(var d=0;d<f.length;d++){c.strokeStyle=g[(d-1)%g.length];c.strokeRect(f[d].x+0.5,f[d].y+0.5,f[d].w-1,f[d].h-1)}c.restore()};b.ui.drawImageGuideRects.guideColors_=["#f00"];b.zip={};b.zip.createDownloadifyZipButton=function(e,d){var c={fileSpecs_:[]};d=d||{};d.swf=d.swf||"lib/downloadify/media/downloadify.swf";d.downloadImage=d.downloadImage||"images/download-zip-button.png";d.width=d.width||133;d.height=d.height||30;d.dataType="base64";d.onError=d.onError||function(){if(c.fileSpecs_.length){alert("There was an error downloading the .zip")}};d.filename=function(){return c.zipFilename_||"output.zip"};d.data=function(){if(!c.fileSpecs_.length){return""}var h=new JSZip();for(var g=0;g<c.fileSpecs_.length;g++){var j=c.fileSpecs_[g];if(j.base64data){h.add(j.name,j.base64data,{base64:true})}else{if(j.textData){h.add(j.name,j.textData)}}}return h.generate()};var f;if(window.Downloadify){f=Downloadify.create($(e).get(0),d)}c.setZipFilename=function(g){c.zipFilename_=g};c.clear=function(){c.fileSpecs_=[]};c.add=function(g){c.fileSpecs_.push(g)};return c};window.studio=b})();